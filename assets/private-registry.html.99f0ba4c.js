import{r as a,o as e,c as n,a as s,b as o,F as r,e as c,d as t}from"./app.43866806.js";const p={},l=c('<h2 id="环境" tabindex="-1"><a class="header-anchor" href="#环境" aria-hidden="true">#</a> 环境</h2><p>创建一台虚拟机为私有仓库，本机向虚拟机的仓库发起上传和下载。</p><h2 id="搭建仓库" tabindex="-1"><a class="header-anchor" href="#搭建仓库" aria-hidden="true">#</a> 搭建仓库</h2><p>在虚拟机上创建仓库，并指定镜像文件存放在本地的默认路径，为其设置 docker 重启后跟随重启。</p><div class="language-bash ext-sh"><pre class="language-bash"><code>docker run -d --restart<span class="token operator">=</span>always --name registry -p <span class="token number">5000</span>:5000 -v /opt/data/registry:/var/lib/registry registry\n</code></pre></div><p>后续的 <code>registry</code> 配置可见 <code>/etc/docker/registry/config.yml</code>。</p><h2 id="主机测试" tabindex="-1"><a class="header-anchor" href="#主机测试" aria-hidden="true">#</a> 主机测试</h2><p>Docker 新的版本对安全性要求较高，要求仓库支持 SSL/TLS 证书，可以在本地信任该仓库。</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">vim</span> /etc/docker/daemon.json\n\n<span class="token comment"># 在 JSON 中追加内容，对应的 IP 地址</span>\n<span class="token punctuation">{</span><span class="token string">&quot;insecure-registries&quot;</span>:<span class="token punctuation">[</span><span class="token string">&quot;192.168.0.107:5000&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\n\n<span class="token comment"># 重启服务</span>\n<span class="token function">sudo</span> systemctl daemon-reload\n<span class="token function">sudo</span> systemctl restart docker\n</code></pre></div><p>主机上传镜像到虚拟机仓库验证。</p><div class="language-bash ext-sh"><pre class="language-bash"><code>docker pull ubuntu\n<span class="token comment"># 打 tag</span>\ndocker tag ubuntu <span class="token number">192.168</span>.0.107:5000/tubuntu\n<span class="token comment"># push</span>\ndocker push <span class="token number">192.168</span>.0.107:5000/tubuntu\n\n<span class="token comment"># 验证</span>\n<span class="token function">curl</span> http://192.168.0.107:5000/v2/_catalog\n<span class="token comment"># {&quot;repositories&quot;:[&quot;tubuntu&quot;]} # 成功</span>\n<span class="token comment"># 还可以直接打开上面链接进行查看</span>\n<span class="token comment"># 或者在虚拟机上查看 ll /opt/data/registry/docker/registry/v2/repositories</span>\n</code></pre></div><p>下载验证。</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># 首先删除本地的镜像</span>\ndocker rmi <span class="token number">192.168</span>.0.107:5000/tubuntu\n<span class="token comment"># 验证</span>\ndocker images\n\n<span class="token comment"># 拉取</span>\ndocker pull <span class="token number">192.168</span>.0.107:5000/tubuntu\n<span class="token comment"># 验证</span>\ndocker images\n</code></pre></div><h2 id="harbor" tabindex="-1"><a class="header-anchor" href="#harbor" aria-hidden="true">#</a> Harbor</h2>',14),d=t("另外一个选择是使用 "),i={href:"https://github.com/goharbor/harbor",target:"_blank",rel:"noopener noreferrer"},h=t("Harbor"),u=t("。"),g=c('<h3 id="_1-获取-harbor" tabindex="-1"><a class="header-anchor" href="#_1-获取-harbor" aria-hidden="true">#</a> 1. 获取 Harbor</h3><p>先下载文件。</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># 目标压缩包</span>\n<span class="token function">wget</span> https://github.com/goharbor/harbor/releases/download/v2.0.5/harbor-offline-installer-v2.0.5.tgz\n\n<span class="token comment"># gpg</span>\n<span class="token function">wget</span> https://github.com/goharbor/harbor/releases/download/v2.0.5/harbor-offline-installer-v2.0.5.tgz.asc\n</code></pre></div><p>获取文件后先校验有没有问题：</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># 校验</span>\ngpg --verify harbor-offline-installer-v2.0.5.tgz.asc harbor-offline-installer-v2.0.5.tgz\n<span class="token comment"># gpg: using RSA key 7722D168DAEC457806C96FF9644FF454C0B4115C</span>\n<span class="token comment"># gpg: Can&#39;t check signature: No public key</span>\n\n<span class="token comment"># 导入公钥</span>\ngpg --keyserver hkps://keyserver.ubuntu.com --receive-keys 7722D168DAEC457806C96FF9644FF454C0B4115C\n\n<span class="token comment"># 再次校验</span>\ngpg --verify harbor-offline-installer-v2.0.5.tgz.asc harbor-offline-installer-v2.0.5.tgz\n</code></pre></div><h3 id="_2-安装" tabindex="-1"><a class="header-anchor" href="#_2-安装" aria-hidden="true">#</a> 2. 安装</h3><p>先进行解压：</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">tar</span> xvf harbor-offline-installer-v2.0.5.tgz\n</code></pre></div><p>修改配置文件：</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">cp</span> harbor.yml.tmpl harbor.yml\n\n<span class="token comment"># 修改配置</span>\n<span class="token function">vim</span> harbor.yml\n</code></pre></div><p>其中 <code>data_volume</code> 挂载数据。</p><p>在安装前需要确认已经准备好 <code>docker</code> 及 <code>docker-compose</code>。</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">bash</span> install.sh\n</code></pre></div><h3 id="_3-重装" tabindex="-1"><a class="header-anchor" href="#_3-重装" aria-hidden="true">#</a> 3. 重装</h3><p>当修改配置后运行 <code>bash prepare</code> 即可。</p><h3 id="_4-用户" tabindex="-1"><a class="header-anchor" href="#_4-用户" aria-hidden="true">#</a> 4. 用户</h3><p>Harbor 使用前需要注册帐号，推送镜像前需要先创建项目，邀请成员才行。</p><h2 id="自签证书" tabindex="-1"><a class="header-anchor" href="#自签证书" aria-hidden="true">#</a> 自签证书</h2><p>Harbor 在非 <code>https</code> 的环境下总是会出现各种各样的问题，而内网使用时需要自签证书解决 <code>https</code> 问题。</p>',19),b=t("Harbor 官网对这一部分有详细的"),k={href:"https://goharbor.io/docs/2.1.0/install-config/configure-https/",target:"_blank",rel:"noopener noreferrer"},x=t("说明"),m=t("，此处稍微简化。"),v=c('<h3 id="_1-生成-ca-证书" tabindex="-1"><a class="header-anchor" href="#_1-生成-ca-证书" aria-hidden="true">#</a> 1. 生成 CA 证书</h3><p>先生成 <code>ca</code> 私钥：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>openssl genrsa -out ca.key <span class="token number">4096</span>\n</code></pre></div><p>再生成 <code>ca</code> 证书：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>openssl req -x509 -new -nodes -sha512 -days <span class="token number">3650</span> <span class="token punctuation">\\</span>\n -subj <span class="token string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.xxx.com&quot;</span> <span class="token punctuation">\\</span>\n -key ca.key <span class="token punctuation">\\</span>\n -out ca.crt\n</code></pre></div><h3 id="_2-生成服务端证书" tabindex="-1"><a class="header-anchor" href="#_2-生成服务端证书" aria-hidden="true">#</a> 2. 生成服务端证书</h3><p>服务端证书包含 <code>.crt</code> 及 <code>.key</code> 文件。</p><p>先生成域名私钥：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>openssl genrsa -out harbor.xxx.com.key <span class="token number">4096</span>\n</code></pre></div><p>再生成证书签名请求（Certificate Signing Request）：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>openssl req -sha512 -new <span class="token punctuation">\\</span>\n    -subj <span class="token string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.xxx.com&quot;</span> <span class="token punctuation">\\</span>\n    -key harbor.xxx.com.key <span class="token punctuation">\\</span>\n    -out harbor.xxx.com.csr\n</code></pre></div><p>再生成 <code>x509 v3</code> 扩展：</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> v3.ext <span class="token operator">&lt;&lt;-</span><span class="token string">EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1=harbor.xxx.com\nDNS.2=xxx\nDNS.3=hostname\nEOF</span>\n</code></pre></div><p>根据 <code>v3.ext</code> 生成证书：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>openssl x509 -req -sha512 -days <span class="token number">3650</span> <span class="token punctuation">\\</span>\n    -extfile v3.ext <span class="token punctuation">\\</span>\n    -CA ca.crt -CAkey ca.key -CAcreateserial <span class="token punctuation">\\</span>\n    -in harbor.xxx.com.csr <span class="token punctuation">\\</span>\n    -out harbor.xxx.com.crt\n</code></pre></div><p>将 <code>crt</code> 转为 <code>cert</code>，以供 Docker client 使用：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>openssl x509 -inform PEM -in harbor.xxx.com.crt -out harbor.xxx.com.cert\n</code></pre></div><h3 id="_3-docker-客户端使用" tabindex="-1"><a class="header-anchor" href="#_3-docker-客户端使用" aria-hidden="true">#</a> 3. Docker 客户端使用</h3><p>需要将证书拷贝至 <code>docker</code> 配置即<code>/etc/docker/certs.d/harbor.xxx.com/</code> 目录下，增加 <code>ca.crt</code> 、<code>harbor.xxx.com.cert</code> 、<code>harbor.xxx.com.key</code> 三个文件，最后结构如下：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>/etc/docker/certs.d/\n    └── harbor.xxx.com\n       ├── harbor.xxx.com.cert\n       ├── harbor.xxx.com.key\n       └── ca.crt\n</code></pre></div><p>配置完成后还需重启 Docker。</p><h3 id="_4-浏览器使用" tabindex="-1"><a class="header-anchor" href="#_4-浏览器使用" aria-hidden="true">#</a> 4. 浏览器使用</h3><p>Manjaro 下找到 SSL 设置，添加 <code>harbor.xxx.com.crt</code> 证书即可。</p><h3 id="_5-注意事项" tabindex="-1"><a class="header-anchor" href="#_5-注意事项" aria-hidden="true">#</a> 5. 注意事项</h3>',24),f=t("在使用 Nginx 反向代理 "),y=s("code",null,"push",-1),_=t(" 存在"),C={href:"https://github.com/goharbor/harbor/issues/13553",target:"_blank",rel:"noopener noreferrer"},q=t("问题"),S=t("。根据 "),F=s("code",null,"common/config/nginx/nginx.conf",-1),N=t(" 中的提示注释，需注意不止一处："),A=s("div",{class:"language-nginx ext-nginx"},[s("pre",{class:"language-nginx"},[s("code",null,[s("span",{class:"token comment"},"# When setting up Harbor behind other proxy, such as an Nginx instance, remove the below line if the proxy already has similar settings."),t("\n"),s("span",{class:"token comment"},"#proxy_set_header X-Forwarded-Proto $scheme;"),t("\n")])])],-1);p.render=function(c,t){const p=a("OutboundLink");return e(),n(r,null,[l,s("p",null,[d,s("a",i,[h,o(p)]),u]),g,s("p",null,[b,s("a",k,[x,o(p)]),m]),v,s("p",null,[f,y,_,s("a",C,[q,o(p)]),S,F,N]),A],64)};export{p as default};
