(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{478:function(a,s,t){"use strict";t.r(s);var e=t(31),r=Object(e.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h2",{attrs:{id:"环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境"}},[a._v("#")]),a._v(" 环境")]),a._v(" "),t("p",[a._v("创建一台虚拟机为私有仓库，本机向虚拟机的仓库发起上传和下载。")]),a._v(" "),t("h2",{attrs:{id:"搭建仓库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#搭建仓库"}},[a._v("#")]),a._v(" 搭建仓库")]),a._v(" "),t("p",[a._v("在虚拟机上创建仓库，并指定镜像文件存放在本地的默认路径，为其设置 docker 重启后跟随重启。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("docker run -d --restart"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("always --name registry -p "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5000")]),a._v(":5000 -v /opt/data/registry:/var/lib/registry registry\n")])])]),t("p",[a._v("后续的 "),t("code",[a._v("registry")]),a._v(" 配置可见 "),t("code",[a._v("/etc/docker/registry/config.yml")]),a._v("。")]),a._v(" "),t("h2",{attrs:{id:"主机测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主机测试"}},[a._v("#")]),a._v(" 主机测试")]),a._v(" "),t("p",[a._v("Docker 新的版本对安全性要求较高，要求仓库支持 SSL/TLS 证书，可以在本地信任该仓库。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /etc/docker/daemon.json\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在 JSON 中追加内容，对应的 IP 地址")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"insecure-registries"')]),a._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"192.168.0.107:5000"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 重启服务")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl daemon-reload\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" systemctl restart docker\n")])])]),t("p",[a._v("主机上传镜像到虚拟机仓库验证。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("docker pull ubuntu\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 打 tag")]),a._v("\ndocker tag ubuntu "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".0.107:5000/tubuntu\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# push")]),a._v("\ndocker push "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".0.107:5000/tubuntu\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 验证")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" http://192.168.0.107:5000/v2/_catalog\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v('# {"repositories":["tubuntu"]} # 成功')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 还可以直接打开上面链接进行查看")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 或者在虚拟机上查看 ll /opt/data/registry/docker/registry/v2/repositories")]),a._v("\n")])])]),t("p",[a._v("下载验证。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 首先删除本地的镜像")]),a._v("\ndocker rmi "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".0.107:5000/tubuntu\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 验证")]),a._v("\ndocker images\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 拉取")]),a._v("\ndocker pull "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".0.107:5000/tubuntu\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 验证")]),a._v("\ndocker images\n")])])]),t("h2",{attrs:{id:"harbor"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#harbor"}},[a._v("#")]),a._v(" Harbor")]),a._v(" "),t("p",[a._v("另外一个选择是使用 "),t("a",{attrs:{href:"https://github.com/goharbor/harbor",target:"_blank",rel:"noopener noreferrer"}},[a._v("Harbor"),t("OutboundLink")],1),a._v("。")]),a._v(" "),t("h3",{attrs:{id:"_1-获取-harbor"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-获取-harbor"}},[a._v("#")]),a._v(" 1. 获取 Harbor")]),a._v(" "),t("p",[a._v("先下载文件。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 目标压缩包")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("wget")]),a._v(" https://github.com/goharbor/harbor/releases/download/v2.0.5/harbor-offline-installer-v2.0.5.tgz\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# gpg")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("wget")]),a._v(" https://github.com/goharbor/harbor/releases/download/v2.0.5/harbor-offline-installer-v2.0.5.tgz.asc\n")])])]),t("p",[a._v("获取文件后先校验有没有问题：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 校验")]),a._v("\ngpg --verify harbor-offline-installer-v2.0.5.tgz.asc harbor-offline-installer-v2.0.5.tgz\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# gpg: using RSA key 7722D168DAEC457806C96FF9644FF454C0B4115C")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# gpg: Can't check signature: No public key")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 导入公钥")]),a._v("\ngpg --keyserver hkps://keyserver.ubuntu.com --receive-keys 7722D168DAEC457806C96FF9644FF454C0B4115C\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 再次校验")]),a._v("\ngpg --verify harbor-offline-installer-v2.0.5.tgz.asc harbor-offline-installer-v2.0.5.tgz\n")])])]),t("h3",{attrs:{id:"_2-安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装"}},[a._v("#")]),a._v(" 2. 安装")]),a._v(" "),t("p",[a._v("先进行解压：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" xvf harbor-offline-installer-v2.0.5.tgz\n")])])]),t("p",[a._v("修改配置文件：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" harbor.yml.tmpl harbor.yml\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 修改配置")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" harbor.yml\n")])])]),t("p",[a._v("其中 "),t("code",[a._v("data_volume")]),a._v(" 挂载数据。")]),a._v(" "),t("p",[a._v("在安装前需要确认已经准备好 "),t("code",[a._v("docker")]),a._v(" 及 "),t("code",[a._v("docker-compose")]),a._v("。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("bash")]),a._v(" install.sh\n")])])]),t("h3",{attrs:{id:"_3-重装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-重装"}},[a._v("#")]),a._v(" 3. 重装")]),a._v(" "),t("p",[a._v("当修改配置后运行 "),t("code",[a._v("bash prepare")]),a._v(" 即可。")]),a._v(" "),t("h3",{attrs:{id:"_4-用户"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-用户"}},[a._v("#")]),a._v(" 4. 用户")]),a._v(" "),t("p",[a._v("Harbor 使用前需要注册帐号，推送镜像前需要先创建项目，邀请成员才行。")]),a._v(" "),t("h2",{attrs:{id:"自签证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自签证书"}},[a._v("#")]),a._v(" 自签证书")]),a._v(" "),t("p",[a._v("Harbor 在非 "),t("code",[a._v("https")]),a._v(" 的环境下总是会出现各种各样的问题，而内网使用时需要自签证书解决 "),t("code",[a._v("https")]),a._v(" 问题。")]),a._v(" "),t("p",[a._v("Harbor 官网对这一部分有详细的"),t("a",{attrs:{href:"https://goharbor.io/docs/2.1.0/install-config/configure-https/",target:"_blank",rel:"noopener noreferrer"}},[a._v("说明"),t("OutboundLink")],1),a._v("，此处稍微简化。")]),a._v(" "),t("h3",{attrs:{id:"_1-生成-ca-证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-生成-ca-证书"}},[a._v("#")]),a._v(" 1. 生成 CA 证书")]),a._v(" "),t("p",[a._v("先生成 "),t("code",[a._v("ca")]),a._v(" 私钥：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("openssl genrsa -out ca.key "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\n")])])]),t("p",[a._v("再生成 "),t("code",[a._v("ca")]),a._v(" 证书：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("openssl req -x509 -new -nodes -sha512 -days "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3650")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n -subj "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.xxx.com"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n -key ca.key "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n -out ca.crt\n")])])]),t("h3",{attrs:{id:"_2-生成服务端证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-生成服务端证书"}},[a._v("#")]),a._v(" 2. 生成服务端证书")]),a._v(" "),t("p",[a._v("服务端证书包含 "),t("code",[a._v(".crt")]),a._v(" 及 "),t("code",[a._v(".key")]),a._v(" 文件。")]),a._v(" "),t("p",[a._v("先生成域名私钥：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("openssl genrsa -out harbor.xxx.com.key "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\n")])])]),t("p",[a._v("再生成证书签名请求（Certificate Signing Request）：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("openssl req -sha512 -new "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -subj "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.xxx.com"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -key harbor.xxx.com.key "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -out harbor.xxx.com.csr\n")])])]),t("p",[a._v("再生成 "),t("code",[a._v("x509 v3")]),a._v(" 扩展：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" v3.ext "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<-")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1=harbor.xxx.com\nDNS.2=xxx\nDNS.3=hostname\nEOF")]),a._v("\n")])])]),t("p",[a._v("根据 "),t("code",[a._v("v3.ext")]),a._v(" 生成证书：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("openssl x509 -req -sha512 -days "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3650")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -extfile v3.ext "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -CA ca.crt -CAkey ca.key -CAcreateserial "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -in harbor.xxx.com.csr "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -out harbor.xxx.com.crt\n")])])]),t("p",[a._v("将 "),t("code",[a._v("crt")]),a._v(" 转为 "),t("code",[a._v("cert")]),a._v("，以供 Docker client 使用：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("openssl x509 -inform PEM -in harbor.xxx.com.crt -out harbor.xxx.com.cert\n")])])]),t("h3",{attrs:{id:"_3-docker-客户端使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-docker-客户端使用"}},[a._v("#")]),a._v(" 3. Docker 客户端使用")]),a._v(" "),t("p",[a._v("需要将证书拷贝至 "),t("code",[a._v("docker")]),a._v(" 配置即"),t("code",[a._v("/etc/docker/certs.d/harbor.xxx.com/")]),a._v(" 目录下，增加 "),t("code",[a._v("ca.crt")]),a._v(" 、"),t("code",[a._v("harbor.xxx.com.cert")]),a._v(" 、"),t("code",[a._v("harbor.xxx.com.key")]),a._v(" 三个文件，最后结构如下：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("/etc/docker/certs.d/\n    └── harbor.xxx.com\n       ├── harbor.xxx.com.cert\n       ├── harbor.xxx.com.key\n       └── ca.crt\n")])])]),t("p",[a._v("配置完成后还需重启 Docker。")]),a._v(" "),t("h3",{attrs:{id:"_4-浏览器使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-浏览器使用"}},[a._v("#")]),a._v(" 4. 浏览器使用")]),a._v(" "),t("p",[a._v("Manjaro 下找到 SSL 设置，添加 "),t("code",[a._v("harbor.xxx.com.crt")]),a._v(" 证书即可。")]),a._v(" "),t("h3",{attrs:{id:"_5-注意事项"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-注意事项"}},[a._v("#")]),a._v(" 5. 注意事项")]),a._v(" "),t("p",[a._v("在使用 Nginx 反向代理 "),t("code",[a._v("push")]),a._v(" 存在"),t("a",{attrs:{href:"https://github.com/goharbor/harbor/issues/13553",target:"_blank",rel:"noopener noreferrer"}},[a._v("问题"),t("OutboundLink")],1),a._v("。根据 "),t("code",[a._v("common/config/nginx/nginx.conf")]),a._v(" 中的提示注释，需注意不止一处：")]),a._v(" "),t("div",{staticClass:"language-nginx extra-class"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# When setting up Harbor behind other proxy, such as an Nginx instance, remove the below line if the proxy already has similar settings.")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#proxy_set_header X-Forwarded-Proto $scheme;")]),a._v("\n")])])])])}),[],!1,null,null,null);s.default=r.exports}}]);