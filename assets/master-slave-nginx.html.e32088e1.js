import{r as n,c as a,a as s,b as e,w as t,F as p,e as c,d as o,o as l}from"./app.cef235ad.js";import{_ as r}from"./plugin-vue_export-helper.5a098b48.js";const i={},u=c('<h2 id="准备" tabindex="-1"><a class="header-anchor" href="#准备" aria-hidden="true">#</a> 准备</h2><table><thead><tr><th>name</th><th>ip</th><th>role</th></tr></thead><tbody><tr><td>web01</td><td>10.0.0.133</td><td>MASTER</td></tr><tr><td>web02</td><td>10.0.0.134</td><td>BACKUP</td></tr></tbody></table>',2),k=o("为虚拟机"),d=o("安装"),m=o("好 Nginx 和 keepalived。"),h=c('<p>修改 Nginx 的主页便于之后识别：</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">vim</span> /usr/local/nginx/html/index.html\n\n<span class="token comment"># 分别为</span>\n<span class="token comment"># &lt;h1&gt;Welcome to nginx1!&lt;/h1&gt;</span>\n<span class="token comment"># &lt;h1&gt;Welcome to nginx2!&lt;/h1&gt;</span>\n</code></pre></div><p>开放端口：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>firewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">80</span>/tcp\n</code></pre></div><p>验证结果：</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">curl</span> -i <span class="token number">10.0</span>.0.133\n<span class="token function">curl</span> -i <span class="token number">10.0</span>.0.134\n</code></pre></div><h2 id="配置主从" tabindex="-1"><a class="header-anchor" href="#配置主从" aria-hidden="true">#</a> 配置主从</h2><h3 id="_1-master-web01" tabindex="-1"><a class="header-anchor" href="#_1-master-web01" aria-hidden="true">#</a> 1. MASTER(web01)</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># 配置 keepalived</span>\n<span class="token function">vim</span> /etc/keepalived/keepalived.conf\n\n<span class="token comment"># 修改内容如下</span>\nglobal_defs <span class="token punctuation">{</span>\n   notification_email <span class="token punctuation">{</span>\n     acassen@firewall.loc\n     failover@firewall.loc\n     sysadmin@firewall.loc\n   <span class="token punctuation">}</span>\n   notification_email_from Alexandre.Cassen@firewall.loc\n   smtp_server <span class="token number">192.168</span>.200.1\n   smtp_connect_timeout <span class="token number">30</span>\n   router_id LVS_DEVEL\n   vrrp_skip_check_adv_addr\n   vrrp_strict\n   vrrp_garp_interval <span class="token number">0</span>\n   vrrp_gna_interval <span class="token number">0</span>\n<span class="token punctuation">}</span>\n\nvrrp_script chk_nginx <span class="token punctuation">{</span>\n    script <span class="token string">&quot;/etc/keepalived/nginx_check.sh&quot;</span>\n    interval <span class="token number">2</span>\n    weight <span class="token number">20</span>\n<span class="token punctuation">}</span>\n\nvrrp_instance VI_1 <span class="token punctuation">{</span>\n    state MASTER\n    interface eth0\n    virtual_router_id <span class="token number">51</span>\n    mcast_src_ip <span class="token number">10.0</span>.0.133\n    priority <span class="token number">100</span>\n    advert_int <span class="token number">1</span>\n    authentication <span class="token punctuation">{</span>\n        auth_type PASS\n        auth_pass <span class="token number">1111</span>\n    <span class="token punctuation">}</span>\n    virtual_ipaddress <span class="token punctuation">{</span>\n        <span class="token number">10.0</span>.0.100\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h3 id="_2-backup-web02" tabindex="-1"><a class="header-anchor" href="#_2-backup-web02" aria-hidden="true">#</a> 2. BACKUP(web02)</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># 配置 keepalived</span>\n<span class="token function">vim</span> /etc/keepalived/keepalived.conf\n\n<span class="token comment"># 修改内容如下</span>\nglobal_defs <span class="token punctuation">{</span>\n   notification_email <span class="token punctuation">{</span>\n     acassen@firewall.loc\n     failover@firewall.loc\n     sysadmin@firewall.loc\n   <span class="token punctuation">}</span>\n   notification_email_from Alexandre.Cassen@firewall.loc\n   smtp_server <span class="token number">192.168</span>.200.1\n   smtp_connect_timeout <span class="token number">30</span>\n   router_id LVS_DEVEL\n<span class="token punctuation">}</span>\n\nvrrp_script chk_nginx <span class="token punctuation">{</span>\n    script <span class="token string">&quot;/etc/keepalived/nginx_check.sh&quot;</span>\n    interval <span class="token number">2</span>\n    weight <span class="token number">20</span>\n<span class="token punctuation">}</span>\n\nvrrp_instance VI_1 <span class="token punctuation">{</span>\n    state BACKUP\n    interface eth0\n    virtual_router_id <span class="token number">51</span>\n    mcast_src_ip <span class="token number">10.0</span>.0.134\n    priority <span class="token number">80</span>\n    advert_int <span class="token number">1</span>\n    authentication <span class="token punctuation">{</span>\n        auth_type PASS\n        auth_pass <span class="token number">1111</span>\n    <span class="token punctuation">}</span>\n    virtual_ipaddress <span class="token punctuation">{</span>\n        <span class="token number">10.0</span>.0.100\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h3 id="_3-check" tabindex="-1"><a class="header-anchor" href="#_3-check" aria-hidden="true">#</a> 3. check</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># 配置 check</span>\n<span class="token function">vim</span> /etc/keepalived/nginx_check.sh\n\n<span class="token comment"># 添加内容如下</span>\n<span class="token comment">#!/bin/bash</span>\n<span class="token assign-left variable">A</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx –no-header <span class="token operator">|</span><span class="token function">wc</span> -l<span class="token variable">`</span></span>\n<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$A</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>\n        /usr/local/nginx/sbin/nginx\n        <span class="token function">sleep</span> <span class="token number">2</span>\n        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx --no-header <span class="token operator">|</span><span class="token function">wc</span> -l<span class="token variable">`</span></span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>\n                <span class="token function">killall</span> keepalived\n        <span class="token keyword">fi</span>\n<span class="token keyword">fi</span>\n\n<span class="token comment"># 添加执行权限</span>\n<span class="token function">chmod</span> +x /etc/keepalived/nginx_check.sh \nll /etc/keepalived <span class="token comment"># 验证</span>\n</code></pre></div><h2 id="测试" tabindex="-1"><a class="header-anchor" href="#测试" aria-hidden="true">#</a> 测试</h2><h3 id="_1-启用服务" tabindex="-1"><a class="header-anchor" href="#_1-启用服务" aria-hidden="true">#</a> 1. 启用服务</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>systemctl start keepalived.service\n\n<span class="token function">ip</span> addr <span class="token comment"># 验证 web01 和 web02</span>\n\n<span class="token comment"># web01</span>\n<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>\n    link/ether 00:0c:29:ea:d2:fc brd ff:ff:ff:ff:ff:ff\n    inet <span class="token number">10.0</span>.0.133/24 brd <span class="token number">10.0</span>.0.255 scope global noprefixroute dynamic eth0\n       valid_lft 1305sec preferred_lft 1305sec\n    inet <span class="token number">10.0</span>.0.100/32 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::5883:fca9:d7da:bd43/64 scope <span class="token function">link</span> noprefixroute \n       valid_lft forever preferred_lft forever\n\n<span class="token comment"># web02（虚拟 ip 未启用）</span>\n<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>\n    link/ether 00:0c:29:82:f0:17 brd ff:ff:ff:ff:ff:ff\n    inet <span class="token number">10.0</span>.0.134/24 brd <span class="token number">10.0</span>.0.255 scope global noprefixroute dynamic eth0\n       valid_lft 869sec preferred_lft 869sec\n    inet6 fe80::5883:fca9:d7da:bd43/64 scope <span class="token function">link</span> tentative noprefixroute dadfailed \n       valid_lft forever preferred_lft forever\n</code></pre></div><h3 id="_2-测试" tabindex="-1"><a class="header-anchor" href="#_2-测试" aria-hidden="true">#</a> 2. 测试</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">curl</span> -i <span class="token number">10.0</span>.0.100 <span class="token comment"># 虚拟 ip</span>\n<span class="token comment"># &lt;h1&gt;Welcome to nginx1!&lt;/h1&gt;</span>\n\n<span class="token comment"># web01</span>\nsystemctl stop nginx-compile.service\nsystemctl stop keepalived.service\n<span class="token function">netstat</span> -lntup <span class="token comment"># 验证</span>\n<span class="token function">ip</span> addr <span class="token comment"># 验证</span>\n\n<span class="token comment"># web02</span>\n<span class="token function">ip</span> addr <span class="token comment"># 验证</span>\n\n<span class="token comment"># 再次测试</span>\n<span class="token function">curl</span> -i <span class="token number">10.0</span>.0.100 <span class="token comment"># 虚拟 ip</span>\n<span class="token comment"># &lt;h1&gt;Welcome to nginx2!&lt;/h1&gt;</span>\n</code></pre></div>',18);var f=r(i,[["render",function(c,o){const r=n("RouterLink");return l(),a(p,null,[u,s("p",null,[k,e(r,{to:"/backend/nginx/install-nginx.html#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"},{default:t((()=>[d])),_:1}),m]),h],64)}]]);export{f as default};
